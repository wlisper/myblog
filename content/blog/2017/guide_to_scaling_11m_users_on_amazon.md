title=新手引导：利用AWS伸缩到千万级用户
date=2017-08-25
type=post
tags=archetecture
status=published
~~~~~~

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org85a7ed2">1. 新手引导：利用AWS伸缩到千万级用户</a>
<ul>
<li><a href="#org62393be">1.1. 基础</a></li>
<li><a href="#orgcac6e52">1.2. 单用户</a></li>
<li><a href="#org6dc4f36">1.3. 垂直伸缩</a></li>
<li><a href="#org2120e3c">1.4. 用户量大于10</a></li>
<li><a href="#org8ec8903">1.5. 用户量大于100</a></li>
<li><a href="#orgd304dc7">1.6. 用户量大于1000</a></li>
<li><a href="#org015df2f">1.7. 用户量一万到十万</a></li>
<li><a href="#orga52b1fe">1.8. 自动伸缩</a></li>
<li><a href="#org7ba5bea">1.9. 用户量大于50万</a></li>
<li><a href="#org1c92550">1.10. 自动化</a></li>
<li><a href="#org544f2c1">1.11. 解耦架构</a></li>
<li><a href="#org0a31f1d">1.12. 不要重复发明轮子</a></li>
<li><a href="#org727f571">1.13. 用户量大于一百万</a></li>
<li><a href="#orgcf3fe1a">1.14. 用户量大于一千万</a></li>
<li><a href="#org4af6b98">1.15. 用户量大于1000万</a></li>
<li><a href="#org49c6bf3">1.16. 总结</a></li>
</ul>
</li>
</ul>
</div>
</div>

<a id="org85a7ed2"></a>

# 新手引导：利用AWS伸缩到千万级用户

本文翻译自：[HighScalability](http://highscalability.com/blog/2016/1/11/a-beginners-guide-to-scaling-to-11-million-users-on-amazons.html)。

如何将系统从单用户伸缩到千万级的用户量？Joel Williams,亚马逊的Web服务方案架构师，就此话题做了一个不错的演讲:[AWS re:Invent 2015 Scaling Up to Your First 10 Million Users](https://www.youtube.com/watch?v=vg5onp8TU6Q&list=PLhr1KZpdzukdRxs_pGJm-qSy5LayL6W_Y)。

如果你是高级AWS用户，这份演讲可能对你没什么用处。但对于新手来说，这却是一个很好的起点。

这份演讲出自亚马逊，所以演讲中亚马逊的服务是解决所有问题的核心。

下面是一些有趣的总结：

-   从SQL开始，只有在必要时才迁移到NOSQL。

-   将系统中的模块分离，使它们可以独立的伸缩并实现差错隔离。

-   将精力投入到你的核心商业业务，不要重新发明轮子。

-   伸缩性和冗余性不是两个分离的概念，你通常能够同时实现二者。


<a id="org62393be"></a>

## 基础

1.  AWS在全球有12个区。
    
    (1) 一个区是一个具体的物理位置，其中包含了多个可用域(AZ, Available Zone)。
    
    (2) 一个可用域通常由一个数据中心或者多个数据中心组成。
    
    (3) 各个可用域之间相互独立，具有独立的电力和网络。
    
    (4) 可用域之间用低延迟网络连接，在地理位置上相距5至15英里。由于网络延迟极低，在应用程序看来，所有的可用域就像是一个整体。
    
    (5) 每个区至少有两个可用域。

2.  AWS在全球有53个边缘区(Edge Location)
    
    (1) 边缘区用于CloudFront,CDN,Route53和Amazon DNS服务
    
    (2) 边缘区使用户可以低延迟的访问数据,无论在什么地理位置.

3.  构建块
    
    (1) AWS提供了众多的构建块服务，这些服务使用可用域作为支撑，具备高可用和容错性。
    
    (2) 你可以付费使用这些服务构建应用，而不是自己构建这些高可用的服务。
    
    (3) 可用域包含的服务有：CloudFront, Route53, S3, DynamoDb, Elastic Load Balancing, EFS, lambda, SQS, SNS, SES, SWF。
    
    (4) 使用单一的可用域也可以构建出高可用的应用程序架构。


<a id="orgcac6e52"></a>

## 单用户

此种情形下，你是唯一的用户，你需要一个可以运行的网站。

你的架构可能是这样的：

1.  应用运行在单一的服务器中。

2.  单一服务器运行整个程序栈：网络层，数据库，管理层..

3.  使用Amazon Route 53做DNS。

4.  为应用绑定一个[Elastic IP](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html)。

5.  应用在一段时间可以工作地很好。


<a id="org6dc4f36"></a>

## 垂直伸缩

1.  你需要一个性能更好的主机。最简单的方案是选择[c4.8xlarge](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/c4-instances.html) 或者[om3.2xlarge](https://aws.amazon.com/ec2/instance-types/)。

2.  垂直伸缩的问题在于：没有差错转移，没有冗余。如果应用出现一个问题，整个服务可能不可用。


<a id="org2120e3c"></a>

## 用户量大于10

1.  单服务器模式切换到多服务器模式。
    
    (1) 一个主机用于web层。
    
    (2) 一个主机用于数据库，或者运行任意多个数据库，这些数据库都由你管理。
    
    (3) 将web主机与数据库主机分离开来可以让它们独立的伸缩。

2.  除了运行自己的数据库，你也可以使用数据库服务。
    
    (1) 你是数据库管理员吗？你想要自己关心数据备份，高可用，打包，操作系统等问题吗？
    
    (2) 使用数据库服务的优势在于：你可以一键点击就生成分布在多个可用域的数据服务，而且是高可用，高可靠的。

3.  AWS提供了多种数据库服务：
    
    (1) Amazon RDS关系数据库服务。
    
    (2) Amazon DynamoDB Nosql数据库服务。
    
    (3) Amazon Redshift 千兆兆级别数据仓库服务。

4.  Amazon Aurora
    
    (1) 自动伸缩到64tb。不用再关心数据的存储。
    
    (2) 有多达15个读集。
    
    (3) 数据增量备份。
    
    (4) 跨越３个可用域的六路数据备份，这可以帮助解决数据访问失败的问题。
    
    (5) 兼容mysql。

5.  从SQL起步，而不是NOSQL
    
    (1) 建议从SQL开始构建数据存储
    
    (2) SQL技术比较成熟
    
    (3) SQL有大量的现存代码，社区，支持组，书籍，以及工具。
    
    (4) SQL足以满足你前1000万用户的需求。
    
    (5) SQL清楚的数据模式便于构建可伸缩的数据服务。

6.  什么时候可以从NOSQL起步?
    
    (1) 你首年即需存储５TB以上的数据或者你的应用有极大的数据紧密性任务。
    
    (2) 你的应用有极低延迟的需求。
    
    (3) 你真的需要高吞吐量。你需要优化读写的性能。
    
    (4) 你的应用中没有关系型数据。


<a id="org8ec8903"></a>

## 用户量大于100

1.  使用单独的主机，用于网络层。

2.  将数据存储到Amazon RDS，由它管理一切。


<a id="orgd304dc7"></a>

## 用户量大于1000

1.  在另一个可用域中开启另一个网络层实例，这样可以提高服务可用性，同时，由于可用域之间网络延迟极低，两个网络层实例就好像一个实例一样。

2.  在另一个可用域中开启一个从数据库，在主数据库故障时，应用程序会自动地向从数据库发送请求。

3.  在配置中加入弹性负载均衡(Elastic Load Balancer, ELB), 用于在你的两个网络实例之间进行负载均衡。
    
    (1) ELB是高可用可管理的负载均衡器。在所有的可用域中均可使用，他是你应用程序的唯一DNS端口。
    
    (2) ELB具有健康检测功能，这可以保证请求不会流入故障的主机。
    
    (3) ELB帮助你进行架构伸缩，让你无需操心太多。


<a id="org015df2f"></a>

## 用户量一万到十万

1.  水平伸缩，在ELB之后可以有1000或更多个网络实例。

2.  添加更多的只读数据集。

3.  考虑到网络层的性能，将网络层的一些流量分离到其他模块，将静态内容移动到Amazon S3和Amazon CloudFront。CloudFront将你的数据存储到边缘区(Edge Location)。

4.  Amazon S3是一个对象存储。

5.  Amazon CloudFront是应用的缓存。

6.  你也可以将回话状态存储到ElasticCache或者DynamoDB，从而减轻网络层的负载。

7.  将数据库的数据缓存到ElastiCache。


<a id="orga52b1fe"></a>

## 自动伸缩

1.  如果你提供足够的资源，能够满足应用高峰时的流量需求，在闲时，你却在浪费资源。

2.  你可以定义最大和最小资源池。

3.  CloudWatch是一个嵌入到所有应用的管理服务，提供伸缩性管理。


<a id="org7ba5bea"></a>

## 用户量大于50万

1.  前一节中, 自动伸缩组加入到网络层配置中。自动伸缩组包括两个可用域，可以伸缩到３个或者更多可用域。

2.  在每个可用域中有3个网络实例，其实可以增加到数千个实例。你可以配置最少需要10个实例，最多伸缩到1000个实例。

3.  ElastiCache用于缓存热数据，减轻数据库负载。

4.  DynamoDB用于管理会话数据。

5.  为应用增加监控，度量，日志功能。

6.  了解用户的体验，是否延迟过高或者遇到什么错误。

7.  通过配置尽量利用系统性能，自动伸缩是很好的解决方案。


<a id="org1c92550"></a>

## 自动化

1.  架构更加复杂，它能伸缩到1000个实例，具有只读数据集，可以水平伸缩。现在我们需要一些自动化管理工具来管理所有的实例。

2.  AWS Elastic Beanstalk，自动管理你的应用设施。


<a id="org544f2c1"></a>

## 解耦架构

1.  使用SOA/microservices。将应用组件分离出来，独立成为单独的服务，就好像你分离网络层和数据库一样。

2.  每个服务都可以独立的伸缩，这带给你更多的灵活性和高可用性。

3.  SOA是架构的核心组件。

4.  低耦合使你更加灵活：
    
    (1) 各组件独立伸缩，差错隔离。
    
    (2) 如果一个工作节点故障，只需启动一个新的节点，这提高了错误处理能力。
    
    (3) 将各个服务设计到独立的黑盒中。
    
    (4) 在服务内部提供伸缩性和冗余性。


<a id="org0a31f1d"></a>

## 不要重复发明轮子

1.  关注你的业务逻辑。

2.  Amazon提供了很多高容错的服务。

3.  SQS：队列服务。

4.  AWS Lambda: 让你无需配置和管理服务器。


<a id="org727f571"></a>

## 用户量大于一百万

1.  用户量达到一百万需要前面提到的所有服务：
    
    (1) 多个可用域
    
    (2) Elastic Load Balanceing(ELB)。
    
    (3) Service Oriented Architecture。
    
    (4) 添加缓存。
    
    (5) 将状态从网络层移除。

2.  使用Amazon SES发送邮件。

3.  使用CloudWatch进行监控。


<a id="orgcf3fe1a"></a>

## 用户量大于一千万

1.  随着用户量增大，数据层成了问题所在。写数据库负载过高，成为瓶颈。

2.  如何解决？
    
    (1) 联合
    
    (2) 分片
    
    (3) 将部分功能转移到Nosql

3.  联合，基于功能将数据分配到多个数据库。
    
    (1) 例如：论坛数据库，用户数据库，产品数据库等等。
    
    (2) 各个数据库可以独立伸缩。
    
    (3) 缺点：不能跨数据库查询，这引出了下一种策略：分片。

4.  分片：将一个数据集切分到多个主机。
    
    (1) 应用层变复杂，可扩展性没有限制。
    
    (2) 比如：将1/3的用户存入shard1，1/3存入shard2，剩下的存入shard3。

5.  将部分功能转移到NoSql


<a id="org4af6b98"></a>

## 用户量大于1000万

1.  伸缩性是一个迭代的过程，随着用户量的增多，你总是可以找到更多的解决方案。

2.  调优应用程序。

3.  更多的SOA。

4.  由多个可用域升级到多个可用区。

5.  开始构建定制的解决方案，专用于解决你遇到的特定问题。

6.  深入分析整个应用栈。


<a id="org49c6bf3"></a>

## 总结

1.  使用多可用域提高可用性。

2.  使用自动伸缩服务。

3.  在应用的各级构建冗余，可伸缩性和冗余性可以同时实现。

4.  有关系性数据库开始构建应用。

5.  缓存数据。

6.  使用自动化管理工具。

7.  保证有较好的测量，监控，日志工具。

8.  SOA。

9.  将部分数据迁移到NoSql。

